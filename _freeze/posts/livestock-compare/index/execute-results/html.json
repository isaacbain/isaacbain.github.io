{
  "hash": "9ae556d3341ad9ace942ec5deecec29f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Livestock numbers through space and time\"\nauthor: \"Isaac Bain\"\ndate: \"2024-07-23\"\ncategories: [code, water quality, maps, animation]\nexecute:\n  warning: false\n  error: false\n  messages: false\nformat: \n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    toc-location: left\n    number-sections: true\n    link-external-icon: true\n    link-external-newwindow: true\neditor: visual\nlightbox: auto\ndraft: true\ndraft-mode: unlinked\nresources: \n  - \"www/*\"\ntitle-block-banner: \"#00000000\"\ntitle-block-banner-color: \"rgba(255, 255, 255, 0.9)\"\ninclude-in-header:\n  - text: |\n      <style>\n      #title-block-header.quarto-title-block.default .quarto-title-meta {\n        color: rgba(255, 255, 255, 0.9);\n      }\n      .quarto-title-block .quarto-title-banner {\n        height: 0; /* hide */\n      }\n      #title-block-header {\n        background: \n          /* top, transparent black, faked with gradient */\n          linear-gradient(\n            rgba(0, 0, 0, 0.2),\n            rgba(0, 0, 0, 0.6)\n          ),\n          /* bottom, image */ \n          url(./cows4.jpg);\n        background-size: cover;\n        background-position-y: center;\n        height: 300px;\n        opacity: 0.7; /* image opacity, lower means lighter */\n        z-index: -1;\n      }\n      </style>\n---\n\n\n\n## Overview\n\nIt seems to be a national past-time to chat about the number of livestock in New Zealand, whether you're interested in the agri-economy, environmental health, or comparing the current ratio of sheep:people.[^1]\n\n[^1]: FYI it's currently 4.6 sheep per person! See [RNZ](https://www.rnz.co.nz/news/country/515877/new-zealand-s-iconic-sheep-to-person-ratio-keeps-falling) for more details.\n\nIn this post, I make some visualisations which will hopefully enable a better understanding of the number of different animals over time and the spatial distribution of livestock across New Zealand.\n\n## Data sources\n\nStatsNZ publish [livestock numbers](https://www.stats.govt.nz/indicators/livestock-numbers/) as part of their series of Agricultural Production Survey (APS) derived data. It's important to note that within this one dataset there are differing levels of spatial resolution and time series:\n\n1.  Total livestock numbers across NZ, 1971-2019\n2.  Regional breakdown, 1990-2019\n3.  APS hex grid breakdown, 1994-2017\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(mapgl)\nlibrary(koordinatr)\nlibrary(zoo)\nlibrary(gganimate)\nlibrary(scales)\nlibrary(isaacr)\nlibrary(pals)\nlibrary(magick)\n\noptions(scipen = 999)\n\n# Load the data\naps17 <- st_read(\"data/livestock-numbers-grid-aps-2017/livestock-numbers-grid-aps-2017.shp\")\naps94 <- st_read(\"data/livestock-numbers-grid-aps-1994/livestock-numbers-grid-aps-1994.shp\")\n\naps17$sheepdens[aps17$grid_id == 724] <- 0\naps17$sheepdens[aps17$grid_id == 742] <- 0\n\nlivestock_numbers_raw <- get_table_as_tibble(Sys.getenv(\"mfe_api_key\"), \"mfe\", \"105406\") |> select(-gml_id)\n\n# Read in the shapefile of regions\nregions_sf <- st_read(\"data/statsnz-regional-council-2023-clipped-generalised-SHP/regional-council-2023-clipped-generalised.shp\") |> \n  mutate(REGC2023_2 = str_replace(REGC2023_2, \" Region$\", \"\")) |> \n  st_simplify(dTolerance = 1000, preserveTopology = FALSE)\n```\n:::\n\n\n\n## Total cattle numbers in New Zealand\n\nFirst up, we'll present how total cattle numbers in New Zealand are changing over time.\n\n-   Total cattle numbers peaked in 2014 with 10.4M cattle.\n-   Around the year 2000 the number of dairy cattle surpassed the number of beef cattle for the first time.\n-   Dairy cattle also peaked in 2014 (6.7M), but beef cattle peaked way back in 1975 (6.3M) and have been fairly steadily declining ever since.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncattle_numbers <- livestock_numbers_raw |>\n  filter(geography_name == \"New Zealand\") |>\n  filter(animal %in% c(\"Beef cattle\", \"Dairy cattle\", \"Total cattle\")) |>\n  group_by(animal) |>\n  mutate(count = na.spline(count, na.rm = FALSE)) # Interpolate missing values via cubic spline interpolation\n\n# Create the plot\np <- ggplot(cattle_numbers, aes(x = year, y = count, colour = animal, group = animal)) +\n  geom_line() + \n  geom_point(size = 2) +\n  geom_text(aes(label = animal), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total cattle numbers in New Zealand\",\n       x = \"\",\n       y = \"Number of cattle\") + \n  theme_minimal() +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  theme(legend.position = \"none\") +\n  scale_colour_brewer(palette = \"Set1\") +\n  scale_y_continuous(breaks = seq(0, max(cattle_numbers$count, na.rm = TRUE), by = 1e6),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels \n  transition_reveal(year)\n\n# Render the animation\nanimate(p,\n        nframes = 100,\n        fps = 10,\n        end_pause = 30)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.gif)\n:::\n:::\n\n\n\nInteractive\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(billboarder)\n\n# Convert count to millions for better readability in the plot\ncattle_numbers2 <- cattle_numbers %>%\n  mutate(count_million = count / 1e6)\n\n# Create the plots\nbillboarder() %>%\n  bb_linechart(\n    data = cattle_numbers2,\n    mapping = bbaes(x = year, y = count_million, group = animal)\n  ) %>%\n  bb_legend(position = \"right\") %>%\n  bb_x_axis(tick = list(values = seq(1971, 2019, by = 5))) %>%\n  bb_y_axis(tick = list(format = suffix(\"M\"))) %>%\n  bb_x_grid(show = TRUE) %>% \n  bb_y_grid(show = TRUE) %>% \n  bb_title(text = \"Total Cattle Numbers in New Zealand\") %>%\n  bb_colors_manual(\"Beef cattle\" = \"#DA0719\", \"Dairy cattle\" = \"#2D6BAA\", \"Total cattle\" = \"#40A33B\") %>%\n  bb_legend(show = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"billboarder html-widget html-fill-item\" style=\"width:100%;height:320px; position: relative;\">\n<a id=\"htmlwidget-36764569e3dbae16d7b9-export\" style=\"position:absolute; top:0; right:0; display:none; z-index:50;\"></a>\n<div id=\"htmlwidget-36764569e3dbae16d7b9\" class=\"billboarder html-widget\" style=\"width:100%;height:320px;\" width=\"100%\" height=\"320px\"></div>\n</div>\n<script type=\"application/json\" data-for=\"htmlwidget-36764569e3dbae16d7b9\">{\"x\":{\"bb_opts\":{\"interaction\":{\"inputType\":{\"touch\":false}},\"line\":{\"classes\":[\"billboarder-line-Beef cattle\",\"billboarder-line-Dairy cattle\",\"billboarder-line-Total cattle\"]},\"data\":{\"x\":\"year\",\"json\":{\"year\":[1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019],\"Beef cattle\":[4.796,5.344,5.765,6.237,6.294,6.087,5.839,5.507275,5.122316,5.162261,5.113419,4.905639,4.496559,4.530565,4.61312,4.880831,4.804178,4.858168,4.526056,4.59316,4.670569,4.676497,4.757962,5.047848,5.182508,4.852179,4.656115654763156,4.640988629479118,4.643705,4.551664277551501,4.454235714853636,4.491281,4.626617,4.4474,4.423626,4.439136,4.393617,4.136872,4.100718,3.94852,3.846414,3.734412,3.698522,3.669862,3.547228,3.533054,3.616091,3.721262,3.889996],\"Dairy cattle\":[3.198,3.288,3.159,3.074,2.998,2.93,2.899,2.910736,2.900089,2.968953,2.922049,3.006664,3.133923,3.245524,3.30803,3.398291,3.19478,3.19973,3.302377,3.440815,3.429427,3.467824,3.55014,3.839184,4.089817,4.165098,4.155770869859203,4.171781078348776,4.316409,4.6413344986317,4.991835395212859,5.161589,5.101603,5.152492,5.087176,5.169557,5.26085,5.57844,5.860776,5.915452,6.174503,6.445681,6.4836,6.698326,6.485535,6.6188,6.529811,6.385541,6.260895],\"Total cattle\":[7.995,8.632,8.923999999999999,9.311,9.292,9.016999999999999,8.739000000000001,8.418011,8.022404999999999,8.131214,8.035468,7.912303,7.630482,7.776089,7.92115,8.279121999999999,7.998958,8.057898,7.828433,8.033975999999999,8.099996000000001,8.144321,8.308102,8.887032,9.272325,9.017277,8.811886525457297,8.812769708388952,8.960114000000001,9.192998775978444,9.446071109944162,9.65287,9.72822,9.599892000000001,9.510802,9.608693000000001,9.654467,9.715312000000001,9.961494,9.863972,10.020917,10.180093,10.182122,10.368188,10.032763,10.151854,10.145902,10.106803,10.150891]},\"types\":{\"Beef cattle\":\"line\",\"Dairy cattle\":\"line\",\"Total cattle\":\"line\"},\"colors\":{\"Beef cattle\":\"#DA0719\",\"Dairy cattle\":\"#2D6BAA\",\"Total cattle\":\"#40A33B\"}},\"point\":{\"show\":false},\"legend\":{\"position\":\"right\",\"show\":true},\"axis\":{\"x\":{\"tick\":{\"values\":[1971,1976,1981,1986,1991,1996,2001,2006,2011,2016]}},\"y\":{\"tick\":{\"format\":\"function(x) {return x + 'M';}\"}}},\"grid\":{\"x\":{\"show\":true},\"y\":{\"show\":true}},\"title\":{\"text\":\"Total Cattle Numbers in New Zealand\",\"position\":\"top-center\"},\"billboarderspecials\":{\"opacity\":1}},\"data\":null},\"evals\":[\"bb_opts.axis.y.tick.format\"],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n## Total sheep numbers in New Zealand\n\nSheep numbers have seen a fairly precipitous decline in New Zealand. \n\n- Since their peak in 1982 at just over 70M, sheep numbers have been declining almost year-on-year to their lowest number on record in 2019 at 26.8M.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and prepare your data\nsheep_numbers <- livestock_numbers_raw |>\n  filter(geography_name == \"New Zealand\") |>\n  filter(animal == \"Sheep\") |>\n  group_by(animal) |>\n  mutate(count = na.spline(count, na.rm = FALSE)) # Interpolate missing values via cubic spline interpolation\n\n# Create the plot\np2 <- ggplot(sheep_numbers, aes(x = year, y = count, colour = animal, group = animal)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = animal), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total sheep numbers for New Zealand\",\n       x = \"\",\n       y = \"Number of sheep\") +\n  theme_minimal() +\n  scale_colour_brewer(palette = \"Set1\") +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  scale_y_continuous(breaks = seq(0, max(sheep_numbers$count, na.rm = TRUE), by = 1e7),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels\n  theme(legend.position = \"none\") +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p2, nframes = 100, fps = 10, end_pause = 20)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.gif)\n:::\n:::\n\n\n\n## Total livestock numbers for New Zealand\n\nA graph like this is useful because it shows just how much more numerous sheep are than the other main livestock types - but the problem is they dominate so much it masks the trends in the other animals, so you can't really see what's going on.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and prepare your data\nlivestock_numbers <- livestock_numbers_raw  |> \n  filter(geography_name == \"New Zealand\") |>\n  group_by(animal) |>\n  mutate(count = na.spline(count, na.rm = FALSE)) |> # Interpolate missing values via cubic spline interpolation\n  filter(count > 0) # Filter out animals with zero counts\n\n# Create the plot\np3 <- ggplot(livestock_numbers, aes(x = year, y = count, colour = animal, group = animal)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = animal), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total livestock numbers for New Zealand\",\n       x = \"\",\n       y = \"Number of animals\") +\n  theme_minimal() +\n  scale_colour_brewer(palette = \"Set1\") +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  scale_y_continuous(breaks = seq(0, max(livestock_numbers$count, na.rm = TRUE), by = 1e7),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels\n  theme(legend.position = \"none\") +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p3, nframes = 100, fps = 10, end_pause = 20)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.gif)\n:::\n:::\n\n\n\n## Total stock unit equivalents\n\nAnother aspect that isn't well communicated by the last type of graph is that the metabolic requirements for the different animals vary drastically. Also, over time the metabolic requirements of animals has changed.\n\n| Stock type | 1980 | 1985 | 2000 | 2017 |\n|------------|------|------|------|------|\n| Sheep      | 0.95 | 0.95 | 1.15 | 1.35 |\n| Beef       | 5    | 5.3  | 6    | 6.9  |\n| Dairy      | 5    | 5.5  | 6.8  | 8    |\n| Deer       | 1.6  | 1.6  | 2    | 2.3  |\n\n: {.sm .hover}\n\n\\\nConverting to stock unit equivalents was the approach Snelder et al. (2021) used to make more useful comparisons. Here I've implemented their same methods of conversion.\n\n-   Total stock units peaked in 2012 at 121.9M stock units equivalents.\n-   Total stock units in New Zealand have actually been high for quite some time, with a relatively small change since 1980 when it was 106M SUs compared to 115 SUs in 2019.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Apply the function to the dataset\ntotal_stock_units <- livestock_numbers_raw |> \n  filter(geography_name == \"New Zealand\") |>\n  filter(animal != \"Total cattle\") |> \n  group_by(animal) |> \n  mutate(count = na.spline(count, na.rm = FALSE)) |> # Interpolate missing values via cubic spline interpolation\n  ungroup() |> \n  rowwise() %>%\n  mutate(stock_unit_equivalent = count * get_stock_unit(animal, year)) %>%\n  ungroup() |> \n  group_by(year) |> \n  summarise(total_stock_unit_equivalent = sum(stock_unit_equivalent, na.rm = TRUE))\n\n# Create the plot\np4 <- ggplot(total_stock_units, aes(x = year, y = total_stock_unit_equivalent)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(label = \"Total stock units\", vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total stock unit equivalents for New Zealand\",\n       x = \"\",\n       y = \"Number of stock units\") +\n  theme_minimal() +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  scale_y_continuous(breaks = seq(0, max(total_stock_units$total_stock_unit_equivalent, na.rm = TRUE), by = 5e7),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels\n  theme(legend.position = \"none\") +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p4, nframes = 100, fps = 10, end_pause = 20)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.gif)\n:::\n:::\n\n\n\n## Regional breakdown\n\n-   Although Waikato still dominates (by a large margin) in terms of dairy cattle numbers, Canterbury is the clear winner (or loser) in terms of the number of dairy cattle added since 1990.\n-   At their peak in 2014, the Waikato had 1.9M dairy cattle, before a slight decrease to 1.8M by 2019.\n-   This is still almost 1.5x greater than the peak number of dairy cows Canterbury (also in 2014), and 2.6x greater than peak dairy cow numbers of 730,000 in Southland in 2015.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndairy_numbers_region <- livestock_numbers_raw |>\n  filter(geography_type == \"Region\") |>\n  filter(geography_name != \"Chatham Islands\") |> \n  filter(animal == \"Dairy cattle\") |>\n  group_by(geography_name) |>\n  mutate(count = na.approx(count, rule = 2, na.rm = FALSE)) |>  # Interpolate missing values via linear interpolation\n  mutate(baseline_1990 = first(count[year == 1990])) |> \n  mutate(change_from_1990 = count - baseline_1990) |> \n  filter(count > 0) |>  # Filter out animals with zero counts |> \n  mutate(year = as.integer(year))\n\n# Create the plot\np5 <- ggplot(dairy_numbers_region, aes(x = year, y = count, colour = geography_name, group = geography_name)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = geography_name), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Dairy cattle numbers by region\",\n       x = \"\",\n       y = \"Number of dairy cattle\") +\n  theme_minimal() +\n  expand_limits(x = c(1990, 2019 + 6), y = 0) + # Expand limits on x-axis\n  theme(legend.position = \"none\") +\n  scale_y_continuous(labels = label_comma()) + # Format y-axis labels with commas\n  scale_color_manual(values = c(\"Canterbury\" = \"red\")) +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p5,\n        nframes = 100,\n        fps = 10,\n        end_pause = 30)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.gif)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create the plot\np6 <- ggplot(dairy_numbers_region, aes(x = year, y = count, colour = geography_name, group = geography_name)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = geography_name), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Dairy cattle numbers by region\",\n       x = \"\",\n       y = \"Number of dairy cattle\") +\n  theme_minimal() +\n  expand_limits(x = c(1990, 2019 + 6), y = 0) + # Expand limits on x-axis\n  theme(legend.position = \"none\") +\n  scale_y_continuous(labels = label_comma()) + # Format y-axis labels with commas\n  scale_color_manual(values=as.vector(ocean.phase(17))) +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p6, nframes = 100, fps = 10, end_pause = 30)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.gif)\n:::\n:::\n\n\n\n### Regional breakdown linked map\n\n*Want the interactive version of this? Click through to this [Shiny app](https://isaacbain.shinyapps.io/livestock-shiny-app/).*\n\n-   As mentioned above, Canterbury really stands out for the increased number of dairy cows since 1990. In the 24 years leading up to 2014 they added over 1.2M dairy cattle to the region.\n-   The opposite end of the spectrum was Auckland, which by 2009 at it's lowest point had lost 135,000 dairy cattle since 1990.\n\n::: column-page-inset\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Merge spatial data with dairy numbers\nmap_data <- dairy_numbers_region %>%\n  left_join(regions_sf, by = c(\"geography_name\" = \"REGC2023_2\")) |> \n  filter(!is.na(LAND_AREA_)) |>  # Filter out regions with missing values |>\n  #filter(geography_name %in% c(\"Canterbury\", \"Southland\", \"Northland\", \"Waikato\", \"Bay of Plenty\")) |> \n  ungroup()\n\n# Calculate the range of change_from_1990\ndairy_change_range <- range(dairy_numbers_region$change_from_1990, na.rm = TRUE)\nmax_abs_change <- max(abs(dairy_change_range))\n\n# Define the limits to be symmetric around zero\nsymmetric_limits <- c(-max_abs_change, max_abs_change)\n\n# Create the line plot\nline_plot <- ggplot(dairy_numbers_region, aes(x = year, y = change_from_1990, colour = change_from_1990, group = geography_name)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = geography_name), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Change in dairy cattle numbers from 1990, by region\",\n       x = \"\",\n       y = \"Number of dairy cattle\") +\n  theme_minimal() +\n  expand_limits(x = c(1990, 2019 + 6)) + # Expand limits on y-axis to match symmetric limits\n  theme(legend.position = \"none\") +\n  scale_color_distiller(\n    palette = \"RdBu\",\n    limits = symmetric_limits,\n    labels = label_comma()) +\n  scale_y_continuous(labels = label_comma()) + # Format y-axis labels with commas\n  transition_reveal(year)\n\n# Create the map plot animation\nmap_plot <- ggplot(map_data) +\n  geom_sf(aes(fill = change_from_1990, geometry = geometry), color = \"black\") +\n  scale_fill_distiller(\n    palette = \"RdBu\",\n    limits = symmetric_limits,\n    labels = label_comma(), \n    name = \"Dairy cattle change \\nfrom 1990\") +\n  theme_void() +\n  theme(legend.position = \"right\") +\n  labs(title = 'Year: {frame_time}') +\n  transition_time(year) +\n  ease_aes('linear')\n\n# Render the individual animations\nline_anim <- animate(line_plot, nframes = 100, fps = 10, end_pause = 30)\nmap_anim <- animate(map_plot, nframes = 100, fps = 10, end_pause = 30)\n\n# Combine the animations side by side using magick\nline_gif <- image_read(line_anim)\nmap_gif <- image_read(map_anim)\ncombined_gif <- image_append(c(line_gif[1], map_gif[1]))\n\n# Ensure both GIFs have the same number of frames\nnum_frames_line <- nrow(image_info(line_gif))\nnum_frames_map <- nrow(image_info(map_gif))\nnum_frames <- min(num_frames_line, num_frames_map)\n\n# Combine the animations side by side\ncombined_gif <- image_append(c(line_gif[1], map_gif[1]), stack = FALSE)\n\nfor (i in 2:num_frames) {\n  combined <- image_append(c(line_gif[i], map_gif[i]), stack = FALSE)\n  combined_gif <- c(combined_gif, combined)\n}\n\n# Add a pause by duplicating the last frame multiple times\npause_duration <- 30 # Number of frames to pause\nlast_frame <- combined_gif[num_frames]\n\nfor (i in 1:pause_duration) {\n  combined_gif <- c(combined_gif, last_frame)\n}\n\n# Display the combined animation\ncombined_gif\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.gif)\n:::\n:::\n\n\n:::\n\n## 2D compare\n\nNow you get a bonus for reading this far! The awesome [Kyle Walker](https://twitter.com/kyle_e_walker) has been writing a brand new R package `[mapgl](https://walker-data.com/mapgl/)` to bring the power of [Mapbox GL JS](https://docs.mapbox.com/mapbox-gl-js/api/) and [MapLibre GL JS](https://maplibre.org/maplibre-gl-js/docs/) to R users. This brings some exciting new features over traditional mapping packages like `[leaflet](https://rstudio.github.io/leaflet/)`.\n\nSo the first map is a simple 2D map of the livestock hex grids, where you can slide the slider back and forth to compare sheep density between the years of 1994 and 2017.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_column <- \"sheepdens\"\nmy_range <- round(range(aps17$sheepdens), 0)\n\nmapboxgl() |>\n  fit_bounds(aps94, animate = FALSE) |>\n  add_fill_layer(id = \"APS 1994\",\n                 source = aps94,\n                 fill_color = interpolate(\n                   column = my_column,\n                   values = c(0, 420), \n                   stops = c(\"#F4F4F3\", \"#A40D23\"),\n                   na_color = \"lightgrey\",\n                 ),\n                 fill_opacity = 0.8) |> \n  add_legend(\"Sheep density <br>1994 / 2017\",\n    values = my_range,\n    colors = c(\"#F4F4F3\", \"#A40D23\")\n  )-> map1\n\nmapboxgl() |> \n  fit_bounds(aps17, animate = FALSE) |>\n  add_fill_layer(id = \"APS 2017\",\n                 source = aps17,\n                 fill_color = interpolate(\n                   column = my_column,\n                   values = c(0, 420), \n                   stops = c(\"#F4F4F3\", \"#A40D23\"),\n                   na_color = \"lightgrey\",\n                 ),\n                 fill_opacity = 0.8) -> map2\n\n# very hacky way to include the map in the html. See issue at: https://github.com/walkerke/mapgl/issues/3\nhtmlwidgets::saveWidget(compare(map1, map2), \"www/map1.html\")\n```\n:::\n\n```{=html}\n\n<style>\n.responsive-iframe-container {\n  position: relative;\n  overflow: hidden;\n  padding-top: 56.25%; /* 16:9 aspect ratio */\n}\n\n.responsive-iframe-container iframe {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  border: 0;\n}\n</style>\n\n<div class=\"responsive-iframe-container\">\n  <iframe src=\"www/map1.html\" allowfullscreen></iframe>\n</div>\n```\n\n\n## 3D compare\n\nBut the next plot is something really special! Now the hex grids are brought into 3D space by setting both their height and colour proportional to the sheep density. You can slide the slider back and forth as above, but you can also hold down the control button whilst clicking to tilt and pan the 3D view.\n\nIt's pretty dramatic in 3D how many less sheep there are these days, and you can clearly see where they've mostly been lost from in the South Island.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_column <- \"sheepdens\"\nmy_range <- round(range(aps17$sheepdens), 0)\n\nmaplibre(\n  style = maptiler_style('basic'),\n  center = c(170.5, -43.5),\n  zoom = 5,\n  pitch = 60,\n  bearing = 0\n) |>\n  add_fill_extrusion_layer(\n    id = \"3d\",\n    source = aps94,\n    fill_extrusion_color = interpolate(\n      column = my_column,\n      values = my_range,\n      stops = c(\"#F4F4F3\", \"#A40D23\")\n    ),\n    fill_extrusion_height = interpolate(\n      column = my_column,\n      values = my_range, # Data values for interpolation\n      stops = c(0, 160000) # Corresponding heights for those values\n    )\n  ) |>\n  add_legend(\"Sheep density <br>1994 / 2017\",\n    values = my_range,\n    colors = c(\"#F4F4F3\", \"#A40D23\")\n  ) -> map3\n\nmaplibre(\n  style = maptiler_style('basic'),\n  center = c(170.5, -43.5),\n  zoom = 5,\n  pitch = 60,\n  bearing = 0\n) |>\n  add_fill_extrusion_layer(\n    id = \"3d\",\n    source = aps17,\n    fill_extrusion_color = interpolate(\n      column = my_column,\n      values = my_range,\n      stops = c('#F4F4F3', '#A40D23')\n    ),\n    fill_extrusion_height = interpolate(\n      column = my_column,\n      values = my_range,  # Data values for interpolation\n      stops = c(0, 160000)  # Corresponding heights for those values\n    )\n  ) -> map4\n\n#compare(map3, map4)\n\n# very hacky way to include the map in the html. See issue at: https://github.com/walkerke/mapgl/issues/3\nhtmlwidgets::saveWidget(compare(map3, map4), \"www/map2.html\")\n```\n:::\n\n```{=html}\n<div class=\"responsive-iframe-container\">\n  <iframe src=\"www/map2.html\" allowfullscreen></iframe>\n</div>\n```\n\n\n## Conclusions\n\nSo that about wraps it up. I hope you learnt some more about the livestock numbers dataset available, and some of the possibilities for visualising them.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/d3-format-1.4.2/d3-format.min.js\"></script>\n<script src=\"../../site_libs/billboarder-binding-0.4.1/billboarder.js\"></script>\n<link href=\"../../site_libs/billboard-3.9.4/billboard/billboard.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/billboard-3.9.4/billboarder.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/billboard-3.9.4/billboard/billboard.pkgd.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}