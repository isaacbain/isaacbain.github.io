{
  "hash": "c84cb2c7114df1e6dc217de97f8b4223",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Herding Data: The Udderly Fascinating Trends in New Zealand Livestock\"\nauthor: \"Isaac Bain\"\ndate: \"2024-07-23\"\ncategories: [code, maps, animation]\nexecute:\n  warning: false\n  error: false\n  messages: false\nformat: \n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    toc-location: left\n    number-sections: true\n    link-external-icon: true\n    link-external-newwindow: true\neditor: visual\nlightbox: auto\ndraft: false\ndraft-mode: unlinked\nresources: \n  - \"www/*\"\ntitle-block-banner: \"#00000000\"\ntitle-block-banner-color: \"rgba(255, 255, 255, 0.9)\"\ninclude-in-header:\n  - text: |\n      <style>\n      #title-block-header.quarto-title-block.default .quarto-title-meta {\n        color: rgba(255, 255, 255, 0.9);\n      }\n      .quarto-title-block .quarto-title-banner {\n        height: 0; /* hide */\n      }\n      #title-block-header {\n        background: \n          /* top, transparent black, faked with gradient */\n          linear-gradient(\n            rgba(0, 0, 0, 0.2),\n            rgba(0, 0, 0, 0.6)\n          ),\n          /* bottom, image */ \n          url(./cows4.jpg);\n        background-size: cover;\n        background-position-y: center;\n        height: 300px;\n        opacity: 0.7; /* image opacity, lower means lighter */\n        z-index: -1;\n      }\n      </style>\n---\n\n\n\n## Introduction\n\nIn New Zealand, discussing livestock numbers is practically a national pastime, whether you’re interested in the agri-economy, environmental health, or the ever-popular sheep-to-people ratio.[^1]\n\n[^1]: FYI it's currently 4.6 sheep per person! See [RNZ](https://www.rnz.co.nz/news/country/515877/new-zealand-s-iconic-sheep-to-person-ratio-keeps-falling) for more details.\n\nIn this post, I will present visualisations aimed at enhancing our understanding of the number and distribution of various livestock over time and across different regions of New Zealand.\n\n## Data sources\n\nStatsNZ publishes [livestock numbers](https://www.stats.govt.nz/indicators/livestock-numbers/) as part of their Agricultural Production Survey (APS) derived data series. It’s important to note that within this single dataset, there are varying levels of spatial resolution and time series:\n\n1.  Total livestock numbers across NZ (1971-2019)\n2.  Regional breakdown (1990-2019)\n3.  APS hex grid breakdown (1994-2017)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(mapgl)\nlibrary(koordinatr)\nlibrary(zoo)\nlibrary(gganimate)\nlibrary(scales)\nlibrary(isaacr)\nlibrary(pals)\nlibrary(magick)\nlibrary(billboarder)\n\noptions(scipen = 999)\n\n# Load the data\naps17 <- st_read(\"data/livestock-numbers-grid-aps-2017/livestock-numbers-grid-aps-2017.shp\")\naps94 <- st_read(\"data/livestock-numbers-grid-aps-1994/livestock-numbers-grid-aps-1994.shp\")\n\naps17$sheepdens[aps17$grid_id == 724] <- 0\naps17$sheepdens[aps17$grid_id == 742] <- 0\n\nlivestock_numbers_raw <- get_table_as_tibble(Sys.getenv(\"mfe_api_key\"), \"mfe\", \"105406\") |> select(-gml_id)\n\n# Read in the shapefile of regions\nregions_sf <- st_read(\"data/statsnz-regional-council-2023-clipped-generalised-SHP/regional-council-2023-clipped-generalised.shp\") |> \n  mutate(REGC2023_2 = str_replace(REGC2023_2, \" Region$\", \"\")) |> \n  st_simplify(dTolerance = 1000, preserveTopology = FALSE)\n```\n:::\n\n\n\n## Trends in Total Cattle Numbers\n\nTo start, let’s examine how total cattle numbers in New Zealand have changed over time.\n\n-   Total cattle numbers peaked in 2014 with 10.4 million cattle.\n-   Around the year 2000, the number of dairy cattle surpassed the number of beef cattle for the first time.\n-   Dairy cattle also peaked in 2014 at 6.7 million, while beef cattle peaked much earlier in 1975 at 6.3 million and have been steadily declining since.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncattle_numbers <- livestock_numbers_raw |>\n  filter(geography_name == \"New Zealand\") |>\n  filter(animal %in% c(\"Beef cattle\", \"Dairy cattle\", \"Total cattle\")) |>\n  group_by(animal) |>\n  mutate(count = na.spline(count, na.rm = FALSE)) # Interpolate missing values via cubic spline interpolation\n\n# Create the plot\np <- ggplot(cattle_numbers, aes(x = year, y = count, colour = animal, group = animal)) +\n  geom_line() + \n  geom_point(size = 2) +\n  geom_text(aes(label = animal), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total cattle numbers in New Zealand\",\n       x = \"\",\n       y = \"Number of cattle\") + \n  theme_minimal() +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  theme(legend.position = \"none\") +\n  scale_colour_brewer(palette = \"Set1\") +\n  scale_y_continuous(breaks = seq(0, max(cattle_numbers$count, na.rm = TRUE), by = 1e6),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels \n  transition_reveal(year)\n\n# Render the animation\nanimate(p,\n        nframes = 100,\n        fps = 10,\n        end_pause = 30)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.gif)\n:::\n:::\n\n\n\n\n::: callout-tip\nThe graph below is interactive. You can hover over the time series to see the exact values, you can hover over the legend to highlight each animal type, and you can click on the legend to show/hide certain animals.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert count to millions for better readability in the plot\ncattle_numbers2 <- cattle_numbers |>\n  mutate(count_million = count / 1e6)\n\n# Create the plots\nbillboarder() |>\n  bb_linechart(\n    data = cattle_numbers2,\n    mapping = bbaes(x = year, y = count_million, group = animal)\n  ) |>\n  bb_legend(position = \"right\") |>\n  bb_x_axis(tick = list(values = seq(1971, 2019, by = 5))) |>\n  bb_y_axis(tick = list(format = suffix(\"M\"))) |>\n  bb_x_grid(show = TRUE) |> \n  bb_y_grid(show = TRUE) |> \n  bb_title(text = \"Total Cattle Numbers in New Zealand\") |>\n  bb_colors_manual(\"Beef cattle\" = \"#DA0719\", \"Dairy cattle\" = \"#2D6BAA\", \"Total cattle\" = \"#40A33B\") |>\n  bb_legend(show = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"billboarder html-widget html-fill-item\" style=\"width:100%;height:320px; position: relative;\">\n<a id=\"htmlwidget-0e1473faa9beaaaccbbe-export\" style=\"position:absolute; top:0; right:0; display:none; z-index:50;\"></a>\n<div id=\"htmlwidget-0e1473faa9beaaaccbbe\" class=\"billboarder html-widget\" style=\"width:100%;height:320px;\" width=\"100%\" height=\"320px\"></div>\n</div>\n<script type=\"application/json\" data-for=\"htmlwidget-0e1473faa9beaaaccbbe\">{\"x\":{\"bb_opts\":{\"interaction\":{\"inputType\":{\"touch\":false}},\"line\":{\"classes\":[\"billboarder-line-Beef cattle\",\"billboarder-line-Dairy cattle\",\"billboarder-line-Total cattle\"]},\"data\":{\"x\":\"year\",\"json\":{\"year\":[1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019],\"Beef cattle\":[4.796,5.344,5.765,6.237,6.294,6.087,5.839,5.507275,5.122316,5.162261,5.113419,4.905639,4.496559,4.530565,4.61312,4.880831,4.804178,4.858168,4.526056,4.59316,4.670569,4.676497,4.757962,5.047848,5.182508,4.852179,4.656115654763156,4.640988629479118,4.643705,4.551664277551501,4.454235714853636,4.491281,4.626617,4.4474,4.423626,4.439136,4.393617,4.136872,4.100718,3.94852,3.846414,3.734412,3.698522,3.669862,3.547228,3.533054,3.616091,3.721262,3.889996],\"Dairy cattle\":[3.198,3.288,3.159,3.074,2.998,2.93,2.899,2.910736,2.900089,2.968953,2.922049,3.006664,3.133923,3.245524,3.30803,3.398291,3.19478,3.19973,3.302377,3.440815,3.429427,3.467824,3.55014,3.839184,4.089817,4.165098,4.155770869859203,4.171781078348776,4.316409,4.6413344986317,4.991835395212859,5.161589,5.101603,5.152492,5.087176,5.169557,5.26085,5.57844,5.860776,5.915452,6.174503,6.445681,6.4836,6.698326,6.485535,6.6188,6.529811,6.385541,6.260895],\"Total cattle\":[7.995,8.632,8.923999999999999,9.311,9.292,9.016999999999999,8.739000000000001,8.418011,8.022404999999999,8.131214,8.035468,7.912303,7.630482,7.776089,7.92115,8.279121999999999,7.998958,8.057898,7.828433,8.033975999999999,8.099996000000001,8.144321,8.308102,8.887032,9.272325,9.017277,8.811886525457297,8.812769708388952,8.960114000000001,9.192998775978444,9.446071109944162,9.65287,9.72822,9.599892000000001,9.510802,9.608693000000001,9.654467,9.715312000000001,9.961494,9.863972,10.020917,10.180093,10.182122,10.368188,10.032763,10.151854,10.145902,10.106803,10.150891]},\"types\":{\"Beef cattle\":\"line\",\"Dairy cattle\":\"line\",\"Total cattle\":\"line\"},\"colors\":{\"Beef cattle\":\"#DA0719\",\"Dairy cattle\":\"#2D6BAA\",\"Total cattle\":\"#40A33B\"}},\"point\":{\"show\":false},\"legend\":{\"position\":\"right\",\"show\":true},\"axis\":{\"x\":{\"tick\":{\"values\":[1971,1976,1981,1986,1991,1996,2001,2006,2011,2016]}},\"y\":{\"tick\":{\"format\":\"function(x) {return x + 'M';}\"}}},\"grid\":{\"x\":{\"show\":true},\"y\":{\"show\":true}},\"title\":{\"text\":\"Total Cattle Numbers in New Zealand\",\"position\":\"top-center\"},\"billboarderspecials\":{\"opacity\":1}},\"data\":null},\"evals\":[\"bb_opts.axis.y.tick.format\"],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n## Decline in Sheep Numbers\n\nSheep numbers in New Zealand have experienced precipitous decline.\n\n-   Since their peak in 1982 at just over 70 million, sheep numbers have been declining almost every year, reaching a record low of 26.8 million in 2019.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and prepare your data\nsheep_numbers <- livestock_numbers_raw |>\n  filter(geography_name == \"New Zealand\") |>\n  filter(animal == \"Sheep\") |>\n  group_by(animal) |>\n  mutate(count = na.spline(count, na.rm = FALSE)) # Interpolate missing values via cubic spline interpolation\n\n# Create the plot\np2 <- ggplot(sheep_numbers, aes(x = year, y = count, colour = animal, group = animal)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = animal), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total sheep numbers for New Zealand\",\n       x = \"\",\n       y = \"Number of sheep\") +\n  theme_minimal() +\n  scale_colour_brewer(palette = \"Set1\") +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  scale_y_continuous(breaks = seq(0, max(sheep_numbers$count, na.rm = TRUE), by = 1e7),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels\n  theme(legend.position = \"none\") +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p2, nframes = 100, fps = 10, end_pause = 20)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.gif)\n:::\n:::\n\n\n\n## Comparing Livestock Populations\n\nA graph of total livestock numbers highlights the sheer dominance of sheep compared to other livestock types. However, this dominance can obscure the trends in other animals, making it difficult to discern their patterns and changes over time.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and prepare your data\nlivestock_numbers <- livestock_numbers_raw  |> \n  filter(geography_name == \"New Zealand\") |>\n  group_by(animal) |>\n  mutate(count = na.spline(count, na.rm = FALSE)) |> # Interpolate missing values via cubic spline interpolation\n  filter(count > 0) # Filter out animals with zero counts\n\n# Create the plot\np3 <- ggplot(livestock_numbers, aes(x = year, y = count, colour = animal, group = animal)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = animal), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total livestock numbers for New Zealand\",\n       x = \"\",\n       y = \"Number of animals\") +\n  theme_minimal() +\n  scale_colour_brewer(palette = \"Set1\") +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  scale_y_continuous(breaks = seq(0, max(livestock_numbers$count, na.rm = TRUE), by = 1e7),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels\n  theme(legend.position = \"none\") +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p3, nframes = 100, fps = 10, end_pause = 20)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.gif)\n:::\n:::\n\n\n\n## Stock Unit Equivalents Explained\n\nThe previous graph doesn’t effectively communicate the varying metabolic demand of different animals, nor the changes in metabolic demand over time. These demands have been increasing due to rising animal size and productivity.\n\n| Stock type | 1980 | 1985 | 2000 | 2017 |\n|------------|------|------|------|------|\n| Sheep      | 0.95 | 0.95 | 1.15 | 1.35 |\n| Beef       | 5    | 5.3  | 6    | 6.9  |\n| Dairy      | 5    | 5.5  | 6.8  | 8    |\n| Deer       | 1.6  | 1.6  | 2    | 2.3  |\n\n: Stock unit equivalent values assumed for sheep, beef, dairy and deer livestock classes between 1980 and 2017. From Snelder et al (2021) {#tbl-stock-units .sm .hover}\n\n\\\nConverting to stock unit equivalents, as done by Snelder et al. (2021),[^2] allows for more meaningful comparisons. I’ve used their methods of conversion for consistency. In short, the count of animals is multiplied by the stock unit equivalent (@tbl-stock-units) for that animal type and nearest year.\n\n[^2]: Snelder TH, Fraser C, Larned ST, Monaghan R, De Malmanche S, Whitehead AL. Attribution of river water-quality trends to agricultural land use and climate variability in New Zealand. Marine and Freshwater Research. 2021;73(1):1-19. doi:10.1071/mf21086\n\n-   Total stock units peaked in 2012 at 121.9 million stock unit equivalents (SU).\n-   Total stock units in New Zealand have remained relatively high over time, with a modest increase from 106 million SUs in 1980 to 115 million SUs in 2019.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Apply the function to the dataset\ntotal_stock_units <- livestock_numbers_raw |> \n  filter(geography_name == \"New Zealand\") |>\n  filter(animal != \"Total cattle\") |> \n  group_by(animal) |> \n  mutate(count = na.spline(count, na.rm = FALSE)) |> # Interpolate missing values via cubic spline interpolation\n  ungroup() |> \n  rowwise() |>\n  mutate(stock_unit_equivalent = count * get_stock_unit(animal, year)) |>\n  ungroup() |> \n  group_by(year) |> \n  summarise(total_stock_unit_equivalent = sum(stock_unit_equivalent, na.rm = TRUE))\n\n# Create the plot\np4 <- ggplot(total_stock_units, aes(x = year, y = total_stock_unit_equivalent)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(label = \"Total stock units\", vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Total stock unit equivalents for New Zealand\",\n       x = \"\",\n       y = \"Number of stock units\") +\n  theme_minimal() +\n  expand_limits(x = c(1971, 2019 + 6), y = 0) + # Expand limits on x-axis\n  scale_y_continuous(breaks = seq(0, max(total_stock_units$total_stock_unit_equivalent, na.rm = TRUE), by = 5e7),\n                     labels = scales::label_number(scale = 1e-6, suffix = \"M\")) + # Format y-axis labels\n  theme(legend.position = \"none\") +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p4, nframes = 100, fps = 10, end_pause = 20)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.gif)\n:::\n:::\n\n\n\n## Regional Livestock Trends\n\n-   Although Waikato still leads significantly in terms of dairy cattle numbers, Canterbury has seen the largest increase in dairy cattle since 1990.\n-   At their peak in 2014, Waikato had 1.9 million dairy cattle, which slightly decreased to 1.8 million by 2019.\n-   Despite this decrease, Waikato’s dairy cattle numbers are still almost 1.5 times greater than Canterbury’s peak of 1.3 million in 2014, and 2.6 times greater than Southland’s peak of 730,000 in 2015.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndairy_numbers_region <- livestock_numbers_raw |>\n  filter(geography_type == \"Region\") |>\n  filter(geography_name != \"Chatham Islands\") |> \n  filter(animal == \"Dairy cattle\") |>\n  group_by(geography_name) |>\n  mutate(count = na.approx(count, rule = 2, na.rm = FALSE)) |>  # Interpolate missing values via linear interpolation\n  mutate(baseline_1990 = first(count[year == 1990])) |> \n  mutate(change_from_1990 = count - baseline_1990) |> \n  filter(count > 0) |>  # Filter out animals with zero counts |> \n  mutate(year = as.integer(year))\n\n# Create the plot\np5 <- ggplot(dairy_numbers_region, aes(x = year, y = count, colour = geography_name, group = geography_name)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = geography_name), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Dairy cattle numbers by region\",\n       x = \"\",\n       y = \"Number of dairy cattle\") +\n  theme_minimal() +\n  expand_limits(x = c(1990, 2019 + 6), y = 0) + # Expand limits on x-axis\n  theme(legend.position = \"none\") +\n  scale_y_continuous(labels = label_comma()) + # Format y-axis labels with commas\n  scale_color_manual(values = c(\"Canterbury\" = \"red\")) +\n  transition_reveal(year)\n\n# Render the animation\nanimate(p5,\n        nframes = 100,\n        fps = 10,\n        end_pause = 30)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.gif)\n:::\n:::\n\n\n\n::: callout-tip\nThe graph below is interactive. It looks pretty busy, but you can hover over the legend to isolate individual regions. And you can click on the legend items to hide or show multiple regions.\n:::\n\n:::{.column-body-outset}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create the plots\nbillboarder(width = 700, height = 500) |>\n  bb_linechart(\n    data = dairy_numbers_region,\n    mapping = bbaes(x = year, y = count, group = geography_name)\n  ) |>\n  bb_legend(position = \"right\") |>\n  bb_x_axis(tick = list(values = seq(1971, 2019, by = 5))) |>\n  bb_y_axis(tick = list(format = htmlwidgets::JS(\"function(d) { return d.toLocaleString(); }\"))) |>\n  bb_x_grid(show = TRUE) |> \n  bb_y_grid(show = TRUE) |> \n  bb_title(text = \"Dairy cattle numbers by region\") |>\n  bb_legend(show = TRUE) |>\n  bb_tooltip(grouped = FALSE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"billboarder html-widget\" style=\"width:700px;height:500px; position: relative;\">\n<a id=\"htmlwidget-5d50b73f1619f35c1fdf-export\" style=\"position:absolute; top:0; right:0; display:none; z-index:50;\"></a>\n<div id=\"htmlwidget-5d50b73f1619f35c1fdf\" class=\"billboarder html-widget\" style=\"width:700px;height:500px;\" width=\"700\" height=\"500\"></div>\n</div>\n<script type=\"application/json\" data-for=\"htmlwidget-5d50b73f1619f35c1fdf\">{\"x\":{\"bb_opts\":{\"interaction\":{\"inputType\":{\"touch\":false}},\"line\":{\"classes\":[\"billboarder-line-Auckland\",\"billboarder-line-Bay of Plenty\",\"billboarder-line-Canterbury\",\"billboarder-line-Gisborne\",\"billboarder-line-Hawke's Bay\",\"billboarder-line-Manawatu-Whanganui\",\"billboarder-line-Marlborough\",\"billboarder-line-Nelson\",\"billboarder-line-Nelson-Marlborough\",\"billboarder-line-Northland\",\"billboarder-line-Otago\",\"billboarder-line-Southland\",\"billboarder-line-Taranaki\",\"billboarder-line-Tasman\",\"billboarder-line-Waikato\",\"billboarder-line-Wellington\",\"billboarder-line-West Coast\"]},\"data\":{\"x\":\"year\",\"json\":{\"year\":[1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019],\"Auckland\":[229711,226738,226749,168163,168754,175952,162334,152211.6666666667,142089.3333333333,131967,138007.6666666667,144048.3333333333,150089,167559,141618,122015,122234,113344,115883,94391,98416,129768,117281,110288,100086,124668,128495.5,132323,116199,123504],\"Bay of Plenty\":[337610,337854,338577,267983,285752,306655,318634,327841,337048,346255,341306.6666666667,336358.3333333333,331410,326885,320923,329776,300509,299013,315183,299696,306884,331536,312326,314679,333375,357039,339170,325175,306711,317633],\"Canterbury\":[112999,120387,127386,169249,212492,239138,246230,255921.6666666667,265613.3333333333,275305,364406.6666666666,453508.3333333333,542610,556339,599643,604756,655676,754937,831666,918480,938453,1006742,1200293,1304618,1333220,1253993,1271057,1308058,1326513,1212575],\"Gisborne\":[3719,3895,3290,4203,6226,7022,9151,8022.333333333334,6893.666666666667,5765,8021,10277,12533,6969,7199.5,7430,7660.5,7891,16432,13483.5,10535,17806,17095,19332,15153,10341,9874,9407,9407,9407],\"Hawke's Bay\":[13532,14172,17114,18845,31707,30955,35898,38882.66666666666,41867.33333333334,44852,59562,74272,88982,92852,91786,82772,79419,80200,99931,93871,113465,90655,93047,95098,98100,81738,90854,87675,87267,78002],\"Manawatu-Whanganui\":[255205,255837,261324,274541,308022,324097,324459,326081,327703,329325,358484,387643,416802,408986,381464,410765,390125,393453,425484,424880,478514,472992,475466,448030,481249,451421,457239,463057,486470,467626],\"Marlborough\":[18123,18123,18123,18123,22648,24035,24935,27629.33333333333,30323.66666666666,33018,32854,32690,32526,28233,26831,30604,25783,23899,33544,29762,25980,30012,33218,27811,40945,27040,25148,25315,21769,18223],\"Nelson\":[1304,1304,1304,1304,1412,1446.615384615385,1481.230769230769,1515.846153846154,1550.461538461539,1585.076923076923,1619.692307692308,1654.307692307692,1688.923076923077,1723.538461538461,1758.153846153846,1792.769230769231,1827.384615384615,1862,1761.5,1661,1560.5,1460,1359.5,1259,4859,8459,2330,2925,2925,2925],\"Nelson-Marlborough\":[70685,72542,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410,74410],\"Northland\":[368983,362547,361063,355647,356561,394986,402230,397033.3333333333,391836.6666666667,386640,392889,399138,405387,374019,399064,343195,378152,367183,392193,392577,353314,384636,397764,383057,352834,380616,404415,379401,367281,334733],\"Otago\":[43775,46461,49996,55854,82173,87768,96695,106026.6666666667,115358.3333333333,124690,151394,178098,204802,181484,174253,161616,180734,218264,232905,257049,262417,307817,336278,367292,376743,384979,312087,333850,331151,352639],\"Southland\":[37772,43956,52762,70910,114378,125806,137552,169356.6666666667,201161.3333333333,232966,274050.6666666667,315135.3333333333,356220,347793,349021,348075,375911,432642,495971,589184,599198,614648,670581,615428,700039,731209,708895,681011,658626,636241],\"Taranaki\":[563115,561149,572227,562096,599083,618543,613697,611903,610109,608315,622776.6666666666,637238.3333333334,651700,623459,664922,615592,598667,589573,571505,607436,645891,625315,604383,595014,585948,541931,555532,590846,547910,587033],\"Tasman\":[46525,46525,46525,46525,49092,52463,54422,61020,67618,74216,71968.33333333333,69720.66666666667,67473,71206,70848,67535,65994,63849,70689,86531,71088,72803,71956,76283,77972,77863,60980,66114,77694,64690],\"Waikato\":[1276689,1251306,1242665,1389596,1437630,1523259,1553004,1536405.333333333,1519806.666666667,1503208,1556620.666666667,1610033.333333333,1663446,1679882,1685661,1726323,1735353,1669472,1717421,1786579,1757624,1795785,1832380,1837858,1914483,1761949,1855170,1871594,1814158,1822904],\"Wellington\":[62521,67065,74182,76870,83935,92376,93363,94670,95977,97284,101916,106548,111180,111973,95020,95274,103290,92787,103525,85331,92375,114120,108174,108647,97599,109992,103398,96804,79130,82779],\"West Coast\":[64499,65518,66079,70212,79251,85156,91022,101012,111002,120992,122208,123424,124640,122572,141401,142370,148730,152481,152869,179416,160791,179308,173651,178907,188417,182298,180956,156204,143531,152552]},\"types\":{\"Auckland\":\"line\",\"Bay of Plenty\":\"line\",\"Canterbury\":\"line\",\"Gisborne\":\"line\",\"Hawke's Bay\":\"line\",\"Manawatu-Whanganui\":\"line\",\"Marlborough\":\"line\",\"Nelson\":\"line\",\"Nelson-Marlborough\":\"line\",\"Northland\":\"line\",\"Otago\":\"line\",\"Southland\":\"line\",\"Taranaki\":\"line\",\"Tasman\":\"line\",\"Waikato\":\"line\",\"Wellington\":\"line\",\"West Coast\":\"line\"}},\"point\":{\"show\":false},\"legend\":{\"position\":\"right\",\"show\":true},\"axis\":{\"x\":{\"tick\":{\"values\":[1971,1976,1981,1986,1991,1996,2001,2006,2011,2016]}},\"y\":{\"tick\":{\"format\":\"function(d) { return d.toLocaleString(); }\"}}},\"grid\":{\"x\":{\"show\":true},\"y\":{\"show\":true}},\"title\":{\"text\":\"Dairy cattle numbers by region\",\"position\":\"top-center\"},\"tooltip\":{\"grouped\":false}},\"data\":null},\"evals\":[\"bb_opts.axis.y.tick.format\"],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n:::\n\n## Animated Regional Trends Map\n\n*Want the interactive version of this? Click through to this [Shiny app](https://isaacbain.shinyapps.io/livestock-shiny-app/).*\n\n-   As mentioned above, Canterbury stands out for its significant increase in dairy cows since 1990. In the 24 years leading up to 2014, the region added over 1.2 million dairy cattle.\n-   At the opposite end of the spectrum is Auckland, which, by 2009, had lost 135,000 dairy cattle since 1990, reaching its lowest point.\n\n::: column-page-inset\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Merge spatial data with dairy numbers\nmap_data <- dairy_numbers_region |>\n  left_join(regions_sf, by = c(\"geography_name\" = \"REGC2023_2\")) |> \n  filter(!is.na(LAND_AREA_)) |>  # Filter out regions with missing values |>\n  #filter(geography_name %in% c(\"Canterbury\", \"Southland\", \"Northland\", \"Waikato\", \"Bay of Plenty\")) |> \n  ungroup()\n\n# Calculate the range of change_from_1990\ndairy_change_range <- range(dairy_numbers_region$change_from_1990, na.rm = TRUE)\nmax_abs_change <- max(abs(dairy_change_range))\n\n# Define the limits to be symmetric around zero\nsymmetric_limits <- c(-max_abs_change, max_abs_change)\n\n# Create the line plot\nline_plot <- ggplot(dairy_numbers_region, aes(x = year, y = change_from_1990, colour = change_from_1990, group = geography_name)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_text(aes(label = geography_name), vjust = -0.5, hjust = 0, size = 4) +\n  labs(title = \"Change in dairy cattle numbers from 1990, by region\",\n       x = \"\",\n       y = \"Number of dairy cattle\") +\n  theme_minimal() +\n  expand_limits(x = c(1990, 2019 + 6)) + # Expand limits on y-axis to match symmetric limits\n  theme(legend.position = \"none\") +\n  scale_color_distiller(\n    palette = \"RdBu\",\n    limits = symmetric_limits,\n    labels = label_comma()) +\n  scale_y_continuous(labels = label_comma()) + # Format y-axis labels with commas\n  transition_reveal(year)\n\n# Create the map plot animation\nmap_plot <- ggplot(map_data) +\n  geom_sf(aes(fill = change_from_1990, geometry = geometry), color = \"black\") +\n  scale_fill_distiller(\n    palette = \"RdBu\",\n    limits = symmetric_limits,\n    labels = label_comma(), \n    name = \"Dairy cattle change \\nfrom 1990\") +\n  theme_void() +\n  theme(legend.position = \"right\") +\n  labs(title = 'Year: {frame_time}') +\n  transition_time(year) +\n  ease_aes('linear')\n\n# Render the individual animations\nline_anim <- animate(line_plot, nframes = 100, fps = 10, end_pause = 30)\nmap_anim <- animate(map_plot, nframes = 100, fps = 10, end_pause = 30)\n\n# Combine the animations side by side using magick\nline_gif <- image_read(line_anim)\nmap_gif <- image_read(map_anim)\ncombined_gif <- image_append(c(line_gif[1], map_gif[1]))\n\n# Ensure both GIFs have the same number of frames\nnum_frames_line <- nrow(image_info(line_gif))\nnum_frames_map <- nrow(image_info(map_gif))\nnum_frames <- min(num_frames_line, num_frames_map)\n\n# Combine the animations side by side\ncombined_gif <- image_append(c(line_gif[1], map_gif[1]), stack = FALSE)\n\nfor (i in 2:num_frames) {\n  combined <- image_append(c(line_gif[i], map_gif[i]), stack = FALSE)\n  combined_gif <- c(combined_gif, combined)\n}\n\n# Add a pause by duplicating the last frame multiple times\npause_duration <- 30 # Number of frames to pause\nlast_frame <- combined_gif[num_frames]\n\nfor (i in 1:pause_duration) {\n  combined_gif <- c(combined_gif, last_frame)\n}\n\n# Display the combined animation\ncombined_gif\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.gif)\n:::\n:::\n\n\n:::\n\n## 2D Livestock Density Comparison\n\nNow you get a bonus for reading this far! The talented [Kyle Walker](https://twitter.com/kyle_e_walker) has been developing a new R package called [mapgl](https://walker-data.com/mapgl/), which brings the power of [Mapbox GL JS](https://docs.mapbox.com/mapbox-gl-js/api/) and [MapLibre GL JS](https://maplibre.org/maplibre-gl-js/docs/) to R users. This package introduces exciting new features that surpass traditional mapping packages like [Leaflet](https://rstudio.github.io/leaflet/).\n\nThe first map is a simple 2D representation of the livestock hex grids, allowing you to slide the slider back and forth to compare sheep density between the years 1994 and 2017.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_column <- \"sheepdens\"\nmy_range <- round(range(aps17$sheepdens), 0)\n\nmapboxgl() |>\n  fit_bounds(aps94, animate = FALSE) |>\n  add_fill_layer(id = \"APS 1994\",\n                 source = aps94,\n                 fill_color = interpolate(\n                   column = my_column,\n                   values = c(0, 420), \n                   stops = c(\"#F4F4F3\", \"#A40D23\"),\n                   na_color = \"lightgrey\",\n                 ),\n                 fill_opacity = 0.8) |> \n  add_legend(\"Sheep density (count/ha) <br>1994 / 2017\",\n    values = my_range,\n    colors = c(\"#F4F4F3\", \"#A40D23\")\n  )-> map1\n\nmapboxgl() |> \n  fit_bounds(aps17, animate = FALSE) |>\n  add_fill_layer(id = \"APS 2017\",\n                 source = aps17,\n                 fill_color = interpolate(\n                   column = my_column,\n                   values = c(0, 420), \n                   stops = c(\"#F4F4F3\", \"#A40D23\"),\n                   na_color = \"lightgrey\",\n                 ),\n                 fill_opacity = 0.8) -> map2\n\n# very hacky way to include the map in the html. See issue at: https://github.com/walkerke/mapgl/issues/3\nhtmlwidgets::saveWidget(compare(map1, map2), \"www/map1.html\")\n```\n:::\n\n```{=html}\n\n<style>\n.responsive-iframe-container {\n  position: relative;\n  overflow: hidden;\n  padding-top: 56.25%; /* 16:9 aspect ratio */\n}\n\n.responsive-iframe-container iframe {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  border: 0;\n}\n</style>\n\n<div class=\"responsive-iframe-container\">\n  <iframe src=\"www/map1.html\" allowfullscreen></iframe>\n</div>\n```\n\n\n## 3D Livestock Density Visualisation\n\nThe next plot is something truly special! The hex grids are rendered in 3D, with both their height and colour proportional to the sheep density. You can slide the slider back and forth as before, but you can also hold down the control button while clicking to tilt and pan the 3D view.\n\nIn 3D, the dramatic reduction in sheep numbers is striking, and you can clearly see where the losses have predominantly occurred in the South Island.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_column <- \"sheepdens\"\nmy_range <- round(range(aps17$sheepdens), 0)\n\nmaplibre(\n  style = maptiler_style('basic'),\n  center = c(170.5, -43.5),\n  zoom = 5,\n  pitch = 60,\n  bearing = 0\n) |>\n  add_fill_extrusion_layer(\n    id = \"3d\",\n    source = aps94,\n    fill_extrusion_color = interpolate(\n      column = my_column,\n      values = my_range,\n      stops = c(\"#F4F4F3\", \"#A40D23\")\n    ),\n    fill_extrusion_height = interpolate(\n      column = my_column,\n      values = my_range, # Data values for interpolation\n      stops = c(0, 160000) # Corresponding heights for those values\n    )\n  ) |>\n  add_legend(\"Sheep density (count/ha) <br>1994 / 2017\",\n    values = my_range,\n    colors = c(\"#F4F4F3\", \"#A40D23\")\n  ) -> map3\n\nmaplibre(\n  style = maptiler_style('basic'),\n  center = c(170.5, -43.5),\n  zoom = 5,\n  pitch = 60,\n  bearing = 0\n) |>\n  add_fill_extrusion_layer(\n    id = \"3d\",\n    source = aps17,\n    fill_extrusion_color = interpolate(\n      column = my_column,\n      values = my_range,\n      stops = c('#F4F4F3', '#A40D23')\n    ),\n    fill_extrusion_height = interpolate(\n      column = my_column,\n      values = my_range,  # Data values for interpolation\n      stops = c(0, 160000)  # Corresponding heights for those values\n    )\n  ) -> map4\n\n#compare(map3, map4)\n\n# very hacky way to include the map in the html. See issue at: https://github.com/walkerke/mapgl/issues/3\nhtmlwidgets::saveWidget(compare(map3, map4), \"www/map2.html\")\n```\n:::\n\n```{=html}\n<div class=\"responsive-iframe-container\">\n  <iframe src=\"www/map2.html\" allowfullscreen></iframe>\n</div>\n```\n\n\n## Conclusions\n\nThat wraps it up. This post explored livestock numbers in New Zealand, highlighting trends and regional variations for cattle and sheep populations. By using stock unit equivalents, we gained deeper insights into these changes.\n\nWe also showcased innovative visualisation techniques, from animations to interactive 3D comparisons, to illustrate these trends effectively.\n\nI hope this has provided valuable insights into the livestock dataset and inspired new ways to visualise agricultural data. Thank you for reading, and stay tuned for more insights and visualisations.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/d3-format-1.4.2/d3-format.min.js\"></script>\n<script src=\"../../site_libs/billboarder-binding-0.4.1/billboarder.js\"></script>\n<link href=\"../../site_libs/billboard-3.9.4/billboard/billboard.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/billboard-3.9.4/billboarder.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/billboard-3.9.4/billboard/billboard.pkgd.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}