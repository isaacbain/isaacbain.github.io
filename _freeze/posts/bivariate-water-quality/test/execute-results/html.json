{
  "hash": "8f29d34811da319a6fbe82af0ddd467b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Bivariate colour scales\"\nsubtitle: \"Mapping livestock density and water quality\"\nauthor: \"Isaac Bain\"\ndate: \"2024-07-15\"\ncategories: [code, water quality, maps]\nexecute:\n  warning: false\n  error: false\n  messages: false\nformat: \n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    toc-location: left\n    number-sections: true\neditor: visual\nlightbox: auto\ndraft: true\ntitle-block-banner: \"#00000000\"\ntitle-block-banner-color: \"rgba(255, 255, 255, 0.9)\"\ninclude-in-header:\n  - text: |\n      <style>\n      #title-block-header.quarto-title-block.default .quarto-title-meta {\n        color: rgba(255, 255, 255, 0.9);\n      }\n      .quarto-title-block .quarto-title-banner {\n        height: 0; /* hide */\n      }\n      #title-block-header {\n        background: \n          /* top, transparent black, faked with gradient */\n          linear-gradient(\n            rgba(0, 0, 0, 0.6),\n            rgba(0, 0, 0, 0.2)\n          ),\n          /* bottom, image */ \n          url(./cows.jpg);\n        background-size: cover;\n        background-position-y: center;\n        height: 300px;\n        opacity: 0.7; /* image opacity, lower means lighter */\n        z-index: -1;\n      }\n      </style>\n---\n\n\n\n## Overview\n\nWe all want river that are safe to swim in, clean water to drink, and healthy freshwater ecosystems. But many areas in New Zealand are not living up to our communities' expectations and require improvement.[^1] Knowing where to target efforts to improve water quality is crucial, and a solid understanding of pressures is needed.\n\n[^1]: <https://environment.govt.nz/publications/our-freshwater-2023/>\n\nIn order for management actions to be effective, they should be based on predictive relationships between land use, stressor levels in receiving waters, and the ecological and cultural responses to these stressors.[^2] Land use intensity is consistently identified as a key pressure on water quality in New Zealand. In both process-based and statistical models predicting water quality it is often the most, or one of the most, significant predictors of *E. coli* and nitrogen concentrations.\n\n[^2]: Scott T. Larned, Jonathan Moores, Jenni Gadd, Brenda Baillie & Marc Schallenberg (2020) Evidence for the effects of land use on freshwater ecosystems in New Zealand, New Zealand Journal of Marine and Freshwater Research, 54:3, 551-591, DOI: 10.1080/00288330.2019.1695634\n\nFor example, in NIWA's most recent random forest modelling of river water quality[^3], the top ten most important predictors of nitrate + nitrite-nitrogen (NNN) and *E. coli* were:\n\n[^3]: <https://environment.govt.nz/assets/publications/spatial-modelling-river-quality.pdf>\n\n| Predictor rank | NNN predictors                   | *E. coli* predictors             |\n|----------------|----------------------------------|----------------------------------|\n| 1              | Stock density                    | Catchment elevation              |\n| 2              | Dairy density                    | Rainfall variability             |\n| 3              | Beef density                     | Stock density                    |\n| 4              | Intensive agriculture land cover | Bare land cover                  |\n| 5              | Urban land cover                 | Intensive agriculture land cover |\n| 6              | Catchment slope                  | Slope                            |\n| 7              | Temperature Minimum              | Urban land cover                 |\n| 8              | Rainfall variability             | Exotic forest land cover         |\n| 9              | Number of warm days              | Local elevation                  |\n| 10             | Catchment elevation              | Catchment phosphorus             |\n\n: {.sm .hover}\n\nIn this analysis, I'm interested in finding out which areas of New Zealand have relatively high or low levels of contamination given relatively high or low livestock density. Which lends itself well to visualising using a bivariate colour scale.\n\nLivestock density is, of course, only one of a number of interacting pressures determining the state of water quality. But this technique only stretches to exploring two variables at once... Trivariate maps would be almost impossible to interpret! I suggest exploring more than two variables at a time may require moving to a full modelling approach and looking at plots like [Partial Dependence Plots](https://scikit-learn.org/stable/modules/partial_dependence.html) (PDP) or [**SH**apley **A**dditive ex**P**lanations](https://towardsdatascience.com/using-shap-values-to-explain-how-your-machine-learning-model-works-732b3f40e137) (SHAP) values.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Show libraries code\"}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(mapview)\nlibrary(koordinatr)\nlibrary(biscale)\nlibrary(cowplot)\nlibrary(patchwork)\nlibrary(ggtext)\n\ncustom_pal4 <- c(\n  \"1-1\" = \"#f2f2f2\", # low x, low y #ffffff\n  \"2-1\" = \"#b9ddff\",\n  \"3-1\" = \"#64bbff\",\n  \"4-1\" = \"#0295ff\", # high x, low y\n  \"1-2\" = \"#fedcb7\",\n  \"2-2\" = \"#b8b8b8\",\n  \"3-2\" = \"#6691bb\",\n  \"4-2\" = \"#0069ba\",\n  \"1-3\" = \"#ffb869\",\n  \"2-3\" = \"#b89168\",\n  \"3-3\" = \"#676767\",\n  \"4-3\" = \"#003867\",\n  \"1-4\" = \"#ff9400\", # low x, high y\n  \"2-4\" = \"#bb6800\",\n  \"3-4\" = \"#693800\",\n  \"4-4\" = \"#000000\" # high x, high y\n)\n```\n:::\n\n\n\n## A primer on bivariate maps\n\n\n\n::: {.cell .column-margin}\n::: {.cell-output-display}\n![Example of bivariate colour scale grid.](test_files/figure-html/fig-pal-1.png){#fig-pal width=672}\n:::\n:::\n\n\n\nBivariate colour scale maps are thematic maps that use two different colour scales to simultaneously display two variables on the same map. This approach allows for the visualisation of the relationship between the two variables across a geographic space. Each colour on the map represents a unique combination of the two variables' values.\n\nTypically, one colour gradient is represented on the x-axis and the other on the y-axis. The intersection of these gradients results in a grid of colours, each representing a different combination of the two variables' values (@fig-pal).\n\n## Livestock vs water quality\n\n### Data sources\n\nThe data for stocking density, *E. coli*, and nitrogen were obtained from the NIWA's latest report on spatial modelling of river water quality in New Zealand. This report utilised monitoring data from 2016 to 2020 to develop model-based predictions for approximately 590,000 unique river segments across the national river network.\n[The study utilised random forest models to predict water quality states. This method involves using an ensemble of regression trees to improve prediction accuracy and handle complex, non-linear relationships between predictors and response variables.]{.aside}\n\nSelected data used in this analysis includes:\n\n-   **Stocking Density**: Represented as the number of livestock units per hectare. Derived from the Agricultural Production Survey hex grids.\n-   **E. coli**: Modelled concentrations measured in colony-forming units per 100 millilitres (cfu/100ml). E. coli serves as an indicator of faecal contamination in water bodies.\n-   **Nitrogen**: Modelled NNN concentrations measured in milligrams per litre (mg/L). Nitrogen levels are indicative of nutrient pollution, primarily from agricultural runoff.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Show data code\"}\n# water quality\n# ecoli_raw <- get_layer_as_sf(Sys.getenv(\"mfe_api_key\"), \"mfe\", \"109886\")\n# saveRDS(ecoli_raw, \"data/ecoli_raw.rds\")\necoli_raw <- readRDS(\"data/ecoli_raw.rds\")\n\necoli <- ecoli_raw |>\n  filter(mesrmnt == \"Median\") |>\n  select(nzsgmnt,\n    median_ecoli = value,\n    strm_rd\n  )\n\nrm(ecoli_raw)\n\n# nitrogen_raw <- get_layer_as_sf(Sys.getenv(\"mfe_api_key\"), \"mfe\", \"109888\")\n# saveRDS(nitrogen_raw, \"data/nitrogen_raw.rds\")\nnitrogen_raw <- readRDS(\"data/nitrogen_raw.rds\")\n\nnitrogen <- nitrogen_raw |>\n  filter(measr_b == \"NNN\") |>\n  select(nzsgmnt,\n    median_nitrogen = value\n  )\n\nrm(nitrogen_raw)\n\n# load predictors\nload(\"data/REC2.4_lcdb5_predictors.RData\")\nrm(ThesePredictors)\n\necoli |>\n  left_join(nitrogen |> st_drop_geometry(), by = join_by(nzsgmnt)) |>\n  left_join(REC2.4_predictors, by = c(\"nzsgmnt\" = \"nzsegment\")) |>\n  select(\n    nzsgmnt,\n    median_ecoli,\n    median_nitrogen,\n    PropDairy_2017,\n    PropSheep_2017,\n    SUDensityTotal_2017,\n    StreamOrder\n  ) |>\n  filter(StreamOrder > 1) |> \n  # filter extreme outliers \n  filter(SUDensityTotal_2017 < 40) -> dat\n```\n:::\n\n\n\n### Scatter plot\n\nLet's start by looking at the relationship between total stock density and median *E. coli* levels. We can see that there is a positive relationship between the two variables - areas with stock density tend to have higher *E. coli* levels (@fig-scatter-plot).\n\nHowever, the relationship is not perfect - there are areas with high stock density and low *E. coli* levels, and vice versa. This is where bivariate maps come in - they allow us to visualise the relationship between two variables across a geographic space.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |> \n  ggplot(aes(SUDensityTotal_2017, median_ecoli)) +\n  geom_point(alpha = 0.01, size = 1) +\n  geom_smooth(method = \"lm\") +\n  theme_minimal() +\n  labs(x = \"Dairy density\", y = \"Median E. coli\")\n```\n\n::: {.cell-output-display}\n![Scatter plot of dairy density and median E. coli levels.](test_files/figure-html/fig-scatter-plot-1.png){#fig-scatter-plot width=672}\n:::\n:::\n\n\n\n### Univariate maps\n\nTraditional maps use just a single colour scale to display a single variable (@fig-uni-maps). Displaying them side by side isn't a bad option - but it's pretty hard to make the comparison of locations with high dairy density and low *E. coli* (and vice versa) right? Well, that's where bivariate maps come in.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Show univariate code\"}\ndat |>\n  arrange(median_ecoli) |>\n  ggplot() +\n  geom_sf(aes(colour = median_ecoli)) +\n  # scale_colour_viridis_c() +\n  scale_colour_gradient(low = \"#f2f2f2\", high = \"#0295ff\") +\n  theme_void(base_size = 8) +\n  theme(plot.title = element_markdown(\n    family = \"sans\", size = rel(1.5), face = \"bold\", color = \"#4b015b\"\n  )) +\n  labs(\n    title = \"E. coli concentrations\",\n    colour = \"Modelled median \\nconcentration of E. coli \\n(cfu/100mL)\"\n  ) -> ecoli_map\n\ndat |>\n  ggplot() +\n  geom_sf(aes(colour = SUDensityTotal_2017)) +\n  scale_colour_gradient(low = \"#f2f2f2\", high = \"#ff9400\") +\n  # scale_fill_viridis_c() +\n  theme_void(base_size = 8) +\n  theme(plot.title = element_markdown(\n    family = \"sans\", size = rel(1.5), face = \"bold\", color = \"#4b015b\"\n  )) +\n  labs(\n    title = \"Total stock units\",\n    colour = \"Catchment density \\nof total stock units \\n(SU/ha)\"\n  ) -> dairy_dens_map\n\necoli_map + dairy_dens_map\n```\n\n::: {.cell-output-display}\n![Univariate maps of median E. coli levels and dairy density.](test_files/figure-html/fig-uni-maps-1.png){#fig-uni-maps width=672}\n:::\n:::\n\n\n\n### Bivariate colour scale maps\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Show prep code\"}\nfinalplot <- function(data, xlab = \"Higher X\", ylab = \"Higher Y\") {\n  map <- ggplot() +\n    geom_sf(\n      data = data, mapping = aes(colour = bi_class), linewidth = 0.5, show.legend = FALSE,\n      # color = \"white\"\n    ) +\n    bi_scale_color(pal = custom_pal4, dim = 4) +\n    bi_theme()\n\n  legend <- bi_legend(\n    pal = custom_pal4,\n    dim = 4,\n    xlab = xlab,\n    ylab = ylab,\n    size = 7,\n    pad_width = 0.5\n  )\n\n  finalPlot <- ggdraw() +\n    draw_plot(map, 0, 0, 1, 1) +\n    draw_plot(legend, 0.2, .65, 0.2, 0.2, 1.25)\n\n  return(finalPlot)\n}\n```\n:::\n\n\n\n#### Total livestock density\n\n::: panel-tabset\n## E. coli\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create classes\nbi_class(\n  dat,\n  x = median_ecoli,\n  y = SUDensityTotal_2017,\n  style = \"fisher\", dim = 4\n) |>\n  finalplot(\n    xlab = \"Higher E.coli\",\n    ylab = \"Higher Stock\"\n  ) -> finalPlotTotalEcoli\n\nfinalPlotTotalEcoli\n```\n\n::: {.cell-output-display}\n![](test_files/figure-html/fig-bi-maps-total-ecoli-1.png){#fig-bi-maps-total-ecoli width=672}\n:::\n:::\n\n\n\n## Nitrogen\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbi_class(\n  dat,\n  x = median_nitrogen,\n  y = SUDensityTotal_2017,\n  style = \"fisher\",\n  dim = 4\n) |>\n  finalplot(\n    xlab = \"Higher nitrogen\",\n    ylab = \"Higher stock\"\n  ) -> finalPlotTotalNitrogen\n\nfinalPlotTotalNitrogen\n```\n\n::: {.cell-output-display}\n![](test_files/figure-html/fig-bi-maps-total-nitrogen-1.png){#fig-bi-maps-total-nitrogen width=672}\n:::\n:::\n\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}