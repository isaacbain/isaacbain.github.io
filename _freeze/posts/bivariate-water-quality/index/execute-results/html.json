{
  "hash": "a1bbb3006d301855ee2b7078eec8fbe4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Bivariate colour scales: livestock density and water quality\"\nauthor: \"Isaac Bain\"\ndate: \"2024-07-09\"\ncategories: [code, water quality, maps]\nexecute:\n  warning: false\n  error: false\n  messages: false\nformat: \n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    toc-location: left\n    number-sections: true\neditor: visual\nlightbox: auto\ndraft: true\n---\n\n\n## Overview\n\nWe all want river that are safe to swim in, clean water to drink, and healthy freshwater ecosystems. But many areas in New Zealand are not living up to our communities' expectations and require improvement.[^1] Knowing where to target efforts to improve water quality is crucial, and a solid understanding of pressures is needed.\n\n[^1]: <https://environment.govt.nz/publications/our-freshwater-2023/>\n\nLand use intensity is consistently identified as a key pressure on water quality in New Zealand.[^2] In both process-based and statistical models predicting water quality it is often the most, or one of the most, significant predictors of *E. coli* and nitrogen concentrations.\n\n[^2]: Scott T. Larned, Jonathan Moores, Jenni Gadd, Brenda Baillie & Marc Schallenberg (2020) Evidence for the effects of land use on freshwater ecosystems in New Zealand, New Zealand Journal of Marine and Freshwater Research, 54:3, 551-591, DOI: 10.1080/00288330.2019.1695634\n\nFor example, in NIWA's most recent random forest modelling of river water quality[^3], the top ten most important predictors of nitrate + nitrite-nitrogen (NNN) and *E. coli* were:\n\n[^3]: <https://environment.govt.nz/assets/publications/spatial-modelling-river-quality.pdf>\n\n| Predictor Rank | NNN Predictors                   | *E. coli* Predictors             |\n|-----------------|----------------------------|----------------------------|\n| 1              | Stock density                    | Catchment elevation              |\n| 2              | Dairy density                    | Rainfall variability             |\n| 3              | Beef density                     | Stock density                    |\n| 4              | Intensive agriculture land cover | Bare land cover                  |\n| 5              | Urban land cover                 | Intensive agriculture land cover |\n| 6              | Catchment slope                  | Slope                            |\n| 7              | Temperature Minimum              | Urban land cover                 |\n| 8              | Rainfall variability             | Exotic forest land cover         |\n| 9              | Number of warm days              | Local elevation                  |\n| 10             | Catchment elevation              | Catchment phosphorus             |\n\nIn this analysis, I'm interested in finding out which areas of New Zealand have relatively high or low levels of contamination given relativley high or low livestock density. Which lends itself well to visualising using a bivariate colour scale.\n\n## Bivariate maps\n\nBivariate colour scale maps are thematic maps that use two different colour scales to simultaneously display two variables on the same map. This approach allows for the visualisation of the relationship between the two variables across a geographic space. Each colour on the map represents a unique combination of the two variables' values.\n\nTypically, one colour gradient is represented on the x-axis and the other on the y-axis. The intersection of these gradients results in a grid of colours, each representing a different combination of the two variables' values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(mapview)\nlibrary(koordinatr)\nlibrary(biscale)\nlibrary(cowplot)\nlibrary(patchwork)\n```\n:::\n\n\n## Data sources\n\nFor this example, river water quality data modelled for every stream segment in the digital river network - this was done by NIWA on behalf of MfE.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# water quality\n# ecoli_raw <- get_layer_as_sf(Sys.getenv(\"mfe_api_key\"), \"mfe\", \"109886\")\n# saveRDS(ecoli_raw, \"data/ecoli_raw.rds\")\necoli_raw <- readRDS(\"data/ecoli_raw.rds\")\n\necoli <- ecoli_raw |>\n  filter(mesrmnt == \"Median\") |> \n  select(nzsgmnt,\n         median_ecoli = value,\n         strm_rd)\n\nrm(ecoli_raw)\n\n# nitrogen_raw <- get_layer_as_sf(Sys.getenv(\"mfe_api_key\"), \"mfe\", \"109888\")\n# saveRDS(nitrogen_raw, \"data/nitrogen_raw.rds\")\nnitrogen_raw <- readRDS(\"data/nitrogen_raw.rds\")\n\nnitrogen <- nitrogen_raw |>\n  filter(measr_b == \"NNN\") |> \n  select(nzsgmnt,\n         median_nitrogen = value)\n  \nrm(nitrogen_raw)\n\n# load predictors\nload(\"data/REC2.4_lcdb5_predictors.RData\")\nrm(ThesePredictors)\n\necoli |>\n  left_join(nitrogen |> st_drop_geometry(), by = join_by(nzsgmnt)) |> \n  left_join(REC2.4_predictors, by = c(\"nzsgmnt\" = \"nzsegment\")) |> \n  select(nzsgmnt,\n         median_ecoli,\n         median_nitrogen,\n         PropDairy_2017,\n         PropSheep_2017,\n         SUDensityTotal_2017,\n         StreamOrder) |> \n  filter(StreamOrder > 1) -> dat\n```\n:::\n\n\n## Univariate maps\n\nLet's take a look at our data sources using traditional maps which just use a single colour scale to display a single variable. They are not bad - but it's pretty hard to image where has high dairy density and low *E. coli* (and vice versa) right? That's where bivariate maps come in.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |>\n  arrange(median_ecoli) |> \n  ggplot() +\n  geom_sf(aes(colour = median_ecoli)) +\n  #scale_colour_viridis_c() +\n  scale_colour_gradient(low = \"#f2f2f2\", high = \"#0295ff\") +\n  theme_void() +\n  labs(title = \"E. coli concentrations\") -> ecoli_map\n\ndat |>\n  ggplot() +\n  geom_sf(aes(colour = PropDairy_2017)) +\n  scale_colour_gradient(low = \"#f2f2f2\", high = \"#ff9400\") +\n  #scale_fill_viridis_c() +\n  theme_void() +\n  labs(title = \"Dairy density\") -> dairy_dens_map\n\necoli_map + dairy_dens_map\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/uni-maps-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncustom_pal4 <- c(\n  \"1-1\" = \"#f2f2f2\", # low x, low y #ffffff\n  \"2-1\" = \"#b9ddff\",\n  \"3-1\" = \"#64bbff\",\n  \"4-1\" = \"#0295ff\", # high x, low y\n  \"1-2\" = \"#fedcb7\",\n  \"2-2\" = \"#b8b8b8\",\n  \"3-2\" = \"#6691bb\",\n  \"4-2\" = \"#0069ba\",\n  \"1-3\" = \"#ffb869\",\n  \"2-3\" = \"#b89168\",\n  \"3-3\" = \"#676767\",\n  \"4-3\" = \"#003867\",\n  \"1-4\" = \"#ff9400\", # low x, high y\n  \"2-4\" = \"#bb6800\",\n  \"3-4\" = \"#693800\",\n  \"4-4\" = \"#000000\" # high x, high y\n)\n\n#bi_pal(custom_pal4, dim = 4, flip_axes = TRUE)\n\nfinalplot <- function(data, xlab = \"Higher X\", ylab = \"Higher Y\") {\n  map <- ggplot() +\n    geom_sf(data = data, mapping = aes(colour = bi_class), linewidth = 0.5, show.legend = FALSE,\n    #color = \"white\"\n    ) +\n    bi_scale_color(pal = custom_pal4, dim = 4) +\n    bi_theme()\n\n  legend <- bi_legend(pal = custom_pal4,\n                      dim = 4,\n                      xlab = xlab,\n                      ylab = ylab,\n                      size = 7,\n                      pad_width = 0.5)\n\n  finalPlot <- ggdraw() +\n    draw_plot(map, 0, 0, 1, 1) +\n    draw_plot(legend, 0.2, .65, 0.2, 0.2, 1.8)\n  \n  return(finalPlot)\n}\n```\n:::\n\n\n## Bivariate colour scale maps\n\n### Total livestock density\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create classes\nbi_class(dat, x = median_ecoli, y = SUDensityTotal_2017, style = \"fisher\", dim = 4) |> \nfinalplot(xlab = \"Higher E.coli\", ylab = \"Higher stock\") -> finalPlotTotalEcoli\n\nfinalPlotTotalEcoli\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-total-1.png){width=2100}\n:::\n\n```{.r .cell-code}\nbi_class(dat, x = median_nitrogen, y = SUDensityTotal_2017, style = \"fisher\", dim = 4) |>\nfinalplot(xlab = \"Higher nitrogen\", ylab = \"Higher stock\") -> finalPlotTotalNitrogen\n\nfinalPlotTotalNitrogen\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-total-2.png){width=2100}\n:::\n:::\n\n\n### Sheep density\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbi_class(dat, x = median_ecoli, y = PropSheep_2017, style = \"fisher\", dim = 4) |> finalplot(xlab = \"Higher E.coli\", ylab = \"Higher sheep\") -> finalPlotSheepEcoli\n\nfinalPlotSheepEcoli\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-sheep-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbi_class(dat, x = median_nitrogen, y = PropSheep_2017, style = \"fisher\", dim = 4) |> finalplot(xlab = \"Higher nitrogen\", ylab = \"Higher sheep\") -> finalPlotSheepNitrogen\n\nfinalPlotSheepNitrogen\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-sheep-2.png){width=672}\n:::\n:::\n\n\n### Dairy density\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create classes\nbi_class(dat, x = median_ecoli, y = PropDairy_2017, style = \"fisher\", dim = 4) |> \nfinalplot(xlab = \"Higher E.coli\", ylab = \"Higher dairy\") -> finalPlotDairyEcoli\n\nfinalPlotDairyEcoli\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-dairy-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbi_class(dat, x = median_nitrogen, y = PropDairy_2017, style = \"fisher\", dim = 4) |>\nfinalplot(xlab = \"Higher nitrogen\", ylab = \"Higher dairy\") -> finalPlotDairyNitrogen\n\nfinalPlotDairyNitrogen\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-dairy-2.png){width=672}\n:::\n:::\n\n\n### Patchwork\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinalPlotSheepEcoli + finalPlotDairyEcoli\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-patchwork-1.png){width=672}\n:::\n\n```{.r .cell-code}\nfinalPlotSheepNitrogen + finalPlotDairyNitrogen\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bi-maps-patchwork-2.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}